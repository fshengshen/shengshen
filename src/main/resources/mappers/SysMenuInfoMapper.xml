<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<!--
菜单操作相关SQL Mapper
@author fyn
@date 2016-06-06
@source Generated by MySQL2Java
-->

<!-- 此命名空间必须和对应Mapper.java文件的命名空间一致 -->
<mapper namespace="com.fyn.sys.mapper.SysMenuInfoMapper">

    <!-- 菜单栏位列表 -->
    <resultMap id="rm" type="com.fyn.sys.beans.SysMenuInfo">
        <result property="menuId" jdbcType="INTEGER" column="menu_id" />
        <result property="menuLevel" jdbcType="INTEGER" column="menu_level" />
        <result property="menuIndex" jdbcType="INTEGER" column="menu_index" />
        <result property="parentMenuId" jdbcType="INTEGER" column="parent_menu_id" />
        <result property="menuName" jdbcType="VARCHAR" column="menu_name" />
        <result property="menuUrl" jdbcType="VARCHAR" column="menu_url" />
        <result property="menuCss" jdbcType="VARCHAR" column="menu_css" />
        <result property="buttonFun" jdbcType="VARCHAR" column="button_fun" />
        <result property="isMenu" jdbcType="VARCHAR" column="is_menu" />
    </resultMap>

    <!-- 获取菜单 -->
    <select id="getSysMenuInfo" resultMap="rm" parameterType="com.fyn.sys.beans.SysMenuInfo">
        SELECT *
          FROM sys_menu_info
         WHERE menu_id = #{menuId}
    </select>

    <!-- 添加菜单 -->
    <insert id="addSysMenuInfo" parameterType="com.fyn.sys.beans.SysMenuInfo">
        INSERT INTO sys_menu_info(menu_id,menu_level,menu_index,parent_menu_id,menu_name,menu_url,menu_css,button_fun,is_menu)
        VALUES (#{menuId},#{menuLevel},#{menuIndex},#{parentMenuId},#{menuName},#{menuUrl},#{menuCss},#{buttonFun},#{isMenu})
    </insert>

    <!-- 修改菜单 -->
    <update id="editSysMenuInfo" parameterType="com.fyn.sys.beans.SysMenuInfo">
        UPDATE sys_menu_info
           SET menu_level=#{menuLevel},
               menu_index=#{menuIndex},
               parent_menu_id=#{parentMenuId},
               menu_name=#{menuName},
               menu_url=#{menuUrl},
               menu_css=#{menuCss},
               button_fun=#{buttonFun},
               is_menu=#{isMenu}
         WHERE menu_id = #{menuId}
    </update>

    <!-- 作废菜单 -->
    <update id="delSysMenuInfo" parameterType="com.fyn.sys.beans.SysMenuInfo">
        UPDATE sys_menu_info
            SET del_flag=1
         WHERE menu_id = #{menuId}
    </update>
    
    <select id="getMenuListByUserId" parameterType="int" resultMap="rm">
    	 SELECT mi.*
          FROM sys_menu_info mi
          LEFT JOIN sys_role_menu rm ON rm.menu_id = mi.menu_id
          LEFT JOIN sys_user_role ur ON ur.role_id = rm.role_id AND ur.user_id = #{userId}
          WHERE mi.is_menu = 1
          GROUP BY mi.menu_id
    </select>
    
    <resultMap id="vorm" type="com.fyn.sys.controller.vo.SysMenuInfoVO">
        <result property="pMenuId" jdbcType="INTEGER" column="menu_id" />
        <result property="pMenuName" jdbcType="VARCHAR" column="menu_name" />
    </resultMap>
    
    <select id="getPMenuListByUserId" parameterType="int" resultMap="vorm">
        SELECT mi.menu_id, mi.menu_name
          FROM sys_menu_info mi
          LEFT JOIN sys_role_menu rm ON rm.menu_id = mi.menu_id
          LEFT JOIN sys_user_role ur ON ur.role_id = rm.role_id AND ur.user_id = #{userId}
          WHERE mi.is_menu = 1
          AND mi.menu_level = 0
          GROUP BY mi.menu_id
    </select>
    
    <select id="getMenuListByPId" parameterType="int" resultMap="rm">
        SELECT mi.*
          FROM sys_menu_info mi
          INNER JOIN sys_role_menu rm ON rm.menu_id = mi.menu_id
          INNER JOIN sys_user_role ur ON ur.role_id = rm.role_id AND ur.user_id = #{userId}
        WHERE parent_menu_id = #{pMenuId}  
    </select>

    <select id="getSysMenuInfoList" resultMap="rm">
        SELECT *
          FROM sys_menu_info
    </select>
    
    <select id="getPMenuList" resultType="com.fyn.sys.controller.vo.MenuTreeVO">
        SELECT menu_id as id , menu_name as text
        FROM sys_menu_info
        WHERE parent_menu_id = 0 
    </select>
    
    <select id="getCMenuList" parameterType="String" resultType="com.fyn.sys.controller.vo.MenuTreeChildVO">
      SELECT menu_id as id , menu_name as text
        FROM sys_menu_info
       WHERE parent_menu_id = #{id} 
    </select>
</mapper>
